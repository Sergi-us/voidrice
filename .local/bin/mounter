#!/bin/bash
# Testversion
# Dieses Skript mountet Android-Telefone und USB-Laufwerke (verschlÃ¼sselt oder nicht). Dieses Skript ersetzt das Ã¤ltere `dmenumount`, das zusÃ¤tzliche Schritte erforderte und keine verschlÃ¼sselten Laufwerke handhaben konnte.
# TODO: Versuche, Laufwerke in crypttab zu entschlÃ¼sseln
# TODO: UnterstÃ¼tzung fÃ¼r das AnschlieÃŸen von iPhones hinzufÃ¼gen (obwohl sie nervig sind).

IFS='
'
# Funktion zum Escapen von Handy-Namen.
escape() {
    echo "$@" | iconv -cf UTF-8 -t ASCII//TRANSLIT | tr -d '[:punct:]' | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed "s/-\+/-/g;s/\(^-\|-\$\)//g"
}

# ÃœberprÃ¼fe auf Handys.
phones="$(simple-mtpfs -l 2>/dev/null | sed "s/^/ğŸ“±/")"
mountedphones="$(grep "simple-mtpfs" /etc/mtab)"
# Wenn es bereits gemountete Handys gibt, entferne sie aus der Liste der mountbaren GerÃ¤te.
[ -n "$mountedphones" ] && phones="$(for phone in $phones; do
    for mounted in $mountedphones; do
        escphone="$(escape "$phone")"
        [[ "$mounted" =~ "$escphone" ]] && break 1
    done && continue 1
    echo "$phone"
done)"

# ÃœberprÃ¼fe auf Laufwerke.
lsblkoutput="$(lsblk -rpo "uuid,name,type,size,label,mountpoint,fstype")"
# Alle LUKS-Laufwerke abrufen
allluks="$(echo "$lsblkoutput" | grep crypto_LUKS)"
# Eine Liste der bereits entschlÃ¼sselten LUKS-Laufwerk-UUIDs abrufen.
decrypted="$(find /dev/disk/by-id/dm-uuid-CRYPT-LUKS2-* | sed "s|.*LUKS2-||;s|-.*||")"
# Funktion zum Formatieren von Laufwerken fÃ¼r dmenu:
filter() { sed "s/ /:/g" | awk -F':' '$7==""{printf "%s%s (%s) %s\n", $1, $3, $5, $6}' ; }

# Nur nicht entschlÃ¼sselte LUKS-Laufwerke abrufen.
unopenedluks="$(for drive in $allluks; do
    uuid="${drive%% *}"
    uuid="${uuid//-}"  # Dies ist ein Bashismus.
    [ -n "$decrypted" ] && for open in $decrypted; do
        [ "$uuid" = "$open" ] && break 1
    done && continue 1
    echo "ğŸ”’ $drive"
done | filter)"

# Alle normalen, nicht verschlÃ¼sselten oder entschlÃ¼sselten Partitionen abrufen, die nicht gemountet sind.
normalparts="$(echo "$lsblkoutput" | grep -v crypto_LUKS | grep 'part\|rom\|crypt' | sed "s/^/ğŸ’¾ /" | filter)"

# Alles in eine Variable hinzufÃ¼gen. Wenn keine mountbaren Laufwerke gefunden werden, beenden.
alldrives="$(echo "$phones
$unopenedluks
$normalparts" | sed "/^$/d;s/ *$//")"

# Beende das Skript, wenn ein sequentieller Befehl fehlschlÃ¤gt.
set -e

test -n "$alldrives"

# Alle gefundenen Laufwerke an dmenu Ã¼bergeben und die Benutzerwahl abrufen.
chosen="$(echo "$alldrives" | dmenu -p "Welches Laufwerk mounten?" -i)"

# Funktion zur Abfrage des Benutzers nach einem Mountpunkt.
getmount() {
    mp="$(find /mnt /media /mount /home -maxdepth 1 -type d 2>/dev/null | dmenu -i -p "Dieses Laufwerk wo mounten?")"
    test -n "$mp"
    if [ ! -d "$mp" ]; then
        mkdiryn=$(printf "Nein\\nJa" | dmenu -i -p "$mp existiert nicht. Erstellen?")
        [ "$mkdiryn" = "Ja" ] && (mkdir -p "$mp" || sudo -A mkdir -p "$mp")
    fi
}

attemptmount() {
    # Versuch, ohne Mountpunkt zu mounten, um zu sehen, ob das Laufwerk in fstab ist.
    sudo -A mount "$chosen" || return 1
    notify-send "ğŸ’¾Laufwerk gemountet." "$chosen gemountet."
    exit
}

case "$chosen" in
    ğŸ’¾*)
        chosen="${chosen%% *}"
        chosen="${chosen:1}"  # Dies ist ein Bashismus.
        attemptmount || getmount
        sudo -A mount "$chosen" "$mp" -o uid="$(id -u)", gid="$(id -g)"
        notify-send "ğŸ’¾Laufwerk gemountet." "$chosen zu $mp gemountet."
        ;;

    ğŸ”’*)
        chosen="${chosen%% *}"
        chosen="${chosen:1}"  # Dies ist ein Bashismus.
        num=0  # Initialisiere die Variable num
        # Nummeriere das Laufwerk.
        while true; do
            [ -f "/dev/mapper/usb$num" ] || break
            num="$(printf "%02d" "$((num + 1))")"
        done

        # EntschlÃ¼sseln in einem Terminalfenster
        ${TERMINAL:-st} -n floatterm -g 60x1 -e sudo cryptsetup open "$chosen" "usb$num"
        # ÃœberprÃ¼fen, ob jetzt entschlÃ¼sselt.
        if ! test -b "/dev/mapper/usb$num"; then
            notify-send "Fehler" "EntschlÃ¼sselung von $chosen fehlgeschlagen."
            exit 1
        fi

        attemptmount || getmount
        sudo -A mount "/dev/mapper/usb$num" "$mp" -o uid="$(id -u)", gid="$(id -g)"
        notify-send "ğŸ”“EntschlÃ¼sseltes Laufwerk gemountet." "$chosen entschlÃ¼sselt und zu $mp gemountet."
        ;;

    ğŸ“±*)
        notify-send "â—Hinweis" "Erlaube jetzt den Dateizugriff auf deinem Handy."
        getmount
        number="${chosen%%:*}"
        number="${chosen:1}"  # Dies ist ein Bashismus.
        sudo -A simple-mtpfs -o allow_other -o fsname="simple-mtpfs-$(escape "$chosen")" --device "$number" "$mp"
        notify-send "ğŸ¤– Android gemountet." "Android-GerÃ¤t zu $mp gemountet."
        ;;
esac
