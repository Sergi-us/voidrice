#!/bin/sh
# SARBS Backup Script
# Backup-Skript für die Synchronisation von Handy's auf den PC
# und Wiederherstellung vom PC auf das Handy
# TODO Verzeichnisse eines Stock Android-Handy's zu DIR_LIST hinzufügen
# TODO Wiederherstellung testen

# Automatisch den Benutzernamen und die Gruppe ermitteln
CLIENT_USER=$(whoami)
CLIENT_GROUP=$(id -gn $CLIENT_USER)

# Pfad zum Handy eintragen
MOBILE_MOUNT_POINT="/mnt/handy"

# Pfad zum Backup-Verzeichnis auf dem PC
BACKUP_DIR="/home/$CLIENT_USER/Handy"

# Liste der zu synchronisierenden Verzeichnisse
DIR_LIST=(
    "Android/"
    "DCIM/"
    "Documents/"
    "Download/"
    "Movies/"
    "Notifications/"
    "Pictures/"
    "Podcasts/"
)

# Funktion zum Durchführen des Backups
perform_backup() {
    local start_time=$(date '+%Y-%m-%d %H:%M:%S')
    echo "Backup wird durchgeführt..."

    for item in "${DIR_LIST[@]}"; do
        echo "Sichere Verzeichnis: $item"
        rsync --verbose --progress --omit-dir-times --no-perms --recursive --inplace --exclude '.*' "$MOBILE_MOUNT_POINT/$item/" "$BACKUP_DIR/$item/"
        echo "Synchronisiert: $item"
    done

    # Backup-Zusammenfassung erstellen
    local end_time=$(date '+%Y-%m-%d %H:%M:%S')
    local total_files=$(find "$BACKUP_DIR" -type f | wc -l)
    local total_size=$(du -sh "$BACKUP_DIR" | cut -f1)

    echo ""
    echo "=== Backup-Zusammenfassung ==="
    echo "Gestartet: $start_time"
    echo "Beendet: $end_time"
    echo "Gesicherte Dateien: $total_files"
    echo "Gesamtgröße: $total_size"
    echo "=========================="

    echo "Backup abgeschlossen."
}

# Funktion zur Wiederherstellung der Dateien vom Backup ins Home-Verzeichnis
perform_restore() {
    echo "Wiederherstellung wird durchgeführt..."
    for item in "${DIR_LIST[@]}"; do
        source="$BACKUP_DIR/$item"
        if [ -e "$source" ]; then
            sudo rsync --verbose --progress --omit-dir-times --no-perms --recursive --inplace --exclude '.*' "$source/" "/home/$CLIENT_USER/$item/"
            echo "Wiederhergestellt: $item"
        else
            echo "Warnung: $source existiert nicht im Backup und wird übersprungen."
        fi
    done
    echo "Wiederherstellung abgeschlossen."
}

# Überprüfen, ob das Handy gemountet ist
check_mount() {
    if mount | grep "$MOBILE_MOUNT_POINT" > /dev/null; then
        echo "Handy ist gemountet."
        return 0
    else
        echo "Handy ist nicht gemountet. Bitte mounten und erneut versuchen."
        return 1
    fi
}

case $1 in
    --backup)
        check_mount && perform_backup ;;
    --restore)
        check_mount && perform_restore ;;
    *)
        echo "Usage: $0 {--backup|--restore}"
        echo "  --backup   Führt das Backup der angegebenen Verzeichnisse durch"
        echo "  --restore  Führt die Wiederherstellung der angegebenen Verzeichnisse vom Backup durch"
        ;;
esac

# Am Ende eine Bestätigung einfügen
read -p "Drücke Enter, um das Terminal zu schließen..."
